<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Planner</title>
  <style>
    body {
      margin: 0;
      background: linear-gradient(135deg,#0d1b3d,#081229);
      font-family: Poppins, sans-serif;
      color: #fff;
      overflow-x: hidden;
    }

    /* ===== SIDEBAR SLIDE IN/OUT BUTTON ===== */
    .toggle-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 1000;
      width: 45px;
      height: 45px;
      background: #5ab3ff;
      border-radius: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      font-size: 24px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.4);
      transition: 0.3s;
    }
    .toggle-btn:hover {
      transform: scale(1.1);
    }

    .planner-container {
      display: flex;
      height: 100vh;
      transition: 0.4s ease;
    }

    /* ===== SIDEBAR ===== */
    .sidebar {
      width: 230px;
      background: #0b1533;
      padding: 20px;
      display: flex;
      flex-direction: column;
      position: fixed;
      top: 0;
      left: 0;
      height: 100%;
      transform: translateX(-100%);
      transition: 0.4s ease;
      z-index: 999;
    }

    .sidebar.open {
      transform: translateX(0);
    }

    .logo {
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 30px;
      color: #5ab3ff;
      text-align: center;
    }

    .menu li {
      list-style: none;
      padding: 12px 0;
      font-size: 18px;
      cursor: pointer;
      transition: 0.3s;
      text-align: center;
    }
    .menu li:hover,
    .menu .active {
      color: #5ab3ff;
      transform: translateX(5px);
    }

    .menu {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .nav-btn {
      background: none;
      border: none;
      color: #d6e8ff;
      font-size: 16px;
      padding: 12px 16px;
      text-align: left;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      font-family: inherit;
      width: 100%;
    }

    .nav-btn:hover {
      background: rgba(90, 179, 255, 0.1);
      color: #5ab3ff;
      transform: translateX(5px);
    }

    .nav-btn.active {
      background: rgba(90, 179, 255, 0.2);
      color: #5ab3ff;
      border-left: 3px solid #5ab3ff;
      padding-left: 13px;
    }

    .nav-btn i {
      font-size: 18px;
    }

    .sidebar-footer {
      margin-top: auto;
      padding-top: 16px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .logout-btn {
      background: none;
      border: 1px solid rgba(90, 179, 255, 0.3);
      color: #d6e8ff;
      padding: 12px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
      font-family: inherit;
    }

    .logout-btn:hover {
      background: rgba(255, 77, 77, 0.1);
      border-color: rgba(255, 77, 77, 0.5);
      color: #ff4d4d;
    }

    .logout-btn i {
      font-size: 18px;
    }

    /* ===== MAIN CONTENT ===== */
    .content {
      flex: 1;
      padding: 30px;
      margin-left: 0;
      width: 100%;
      transition: margin-left 0.4s ease;
    }
    .content.shift {
      margin-left: 230px;
    }

    .hero h1 { 
      font-size: 36px; 
      margin: 0;
      display: flex;
      justify-content: center;
      
    }
    .hero p { opacity: 0.8;      display: flex;
      justify-content: center; }

    .stats {
      display: flex;
      gap: 20px;
      margin-top: 25px;
      flex-wrap: wrap;
      justify-content: center;
      padding: 20px;
    }

    .card {
      width: 400px;
      padding: 50px;
      border-radius: 15px;
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      box-shadow: 0 0 20px rgba(0,0,0,0.3);
      transition: 0.3s;
    }
    .card:hover { transform: translateY(-5px); }

    .blue { border-left: 5px solid #5ab3ff; }
    .darkblue { border-left: 5px solid #2d6cdf; }

    .subjects h2 { margin-top: 40px; 
      text-align: center; }

.subject-list {
  margin-top: 15px;
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  gap: 16px;
  justify-content: center;
  max-width: 1100px;        /* Ensures max 4 per row */
  margin-left: auto;
  margin-right: auto;
}

.subject-card {
  background: #fff;
  padding: 20px;
  width: 100%;
  border-radius: 12px;
  max-width: 260px;
}



    .subject-item {
      padding: 16px;
      background: rgba(255,255,255,0.06);
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      min-height: 100px;
      transition: transform 0.18s ease, box-shadow 0.18s ease;
    }
    .subject-item:hover { transform: translateY(-6px); box-shadow: 0 10px 30px rgba(0,0,0,0.45); }

    .subject-title { font-weight: 700; font-size: 16px; margin-bottom: 8px; color: #fff; }
    .subject-meta { display:flex; gap:8px; align-items:center; color: #d6e8ff; font-size: 13px; }
    .subject-badge { padding: 4px 8px; border-radius: 999px; background: rgba(255,255,255,0.04); font-weight: 600; }
    .subject-score { margin-left: auto; font-weight: 800; color: #5ab3ff; }
    .subject-actions { margin-top: 10px; display:flex; justify-content: flex-end; gap:8px; }
    .delete-btn { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); padding: 6px 10px; border-radius: 8px; cursor: pointer; color: #fff; }

    .delete-btn {
      background: red;
      border: none;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      color: white;
    }

.add-box {
  margin-top: 20px;
  display: flex;
  gap: 10px;
  justify-content: center;  /* Center the whole box */
}

/* SAME HEIGHT */
#subjectInput,
#addSubjectBtn {
  height: 45px;            /* Set same height */
  border-radius: 8px;
  border: none;
}

/* SAME WIDTH */
#subjectInput {
  width: 250px;            /* Set equal width */
  padding: 0 12px;
}

#addSubjectBtn {
  width: 250px;            /* Same width as input */
  background: #5ab3ff;
  color: white;
  cursor: pointer;
}

    /* Subject modal */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 2000; }
    .modal-card { background: #06102a; color: #e6f4ff; padding: 20px; border-radius: 12px; width: 90%; max-width: 720px; box-shadow: 0 10px 40px rgba(0,0,0,0.6); }
    .modal-header { display:flex; align-items:center; gap:12px; }
    .badge-high { background: #ff4d4d; color: white; padding:4px 8px; border-radius:999px; font-weight:700; }
    .badge-medium { background: #ffb86b; color: #2b1a00; padding:4px 8px; border-radius:999px; font-weight:700; }
    .badge-low { background: #7ef3a6; color: #04321a; padding:4px 8px; border-radius:999px; font-weight:700; }
    .badge-user { background: rgba(255,255,255,0.06); color: #d6e8ff; padding:4px 8px; border-radius:999px; font-weight:700; }
    .modal-body { margin-top: 12px; display: grid; grid-template-columns: 1fr 220px; gap: 12px; }
    .modal-list { max-height: 320px; overflow: auto; }
    .close-modal { background: transparent; border: 1px solid rgba(255,255,255,0.08); color: #d6e8ff; padding: 6px 10px; border-radius: 8px; cursor: pointer; }
  </style>
</head>
<body>

<!-- Sidebar Toggle Button -->
<div class="toggle-btn" onclick="toggleSidebar()">☰</div>

<div class="planner-container">
  <aside class="sidebar" id="sidebar">
    <h2 class="logo">AI Planner</h2>
    <div class="menu">
      <button class="nav-btn" onclick="location.href='/dashboard'"><i class="fa-solid fa-chart-line"></i> Dashboard</button>
      <button class="nav-btn" onclick="location.href='/planner'"><i class="fa-regular fa-calendar"></i> Planner</button>
      <button class="nav-btn" onclick="location.href='/chatbot'"><i class="fa-regular fa-message"></i> Chatbot</button>
      <button class="nav-btn" onclick="location.href='/notes_sumariser'"><i class="fa-solid fa-book"></i> Video to Notes</button>
      <button class="nav-btn" onclick="location.href='/quiz'"><i class="fa-solid fa-medal"></i> Quizzes</button>
      <button class="nav-btn" onclick="location.href='/reminders'"><i class="fa-solid fa-medal"></i> Reminders</button>
      <div class="sidebar-footer">
        <button class="logout-btn" onclick="location.href='/auth/logout'"> <i class="fa-solid fa-right-from-bracket"></i> Logout</button>
      </div>
    </div>
  </aside>

  <main class="content" id="content">
    <section class="hero">
      <h1>Smart Study Planner</h1>
      <p>AI-powered confidence, learning velocity & recommendations</p>
    </section>

    <section class="stats">
      <div class="card blue">
        <h3>AI Confidence</h3>
        <p id="ai_confidence">--</p>
      </div>
      <div class="card darkblue">
        <h3>Learning Velocity</h3>
        <p id="learning_velocity">--</p>
      </div>
    </section>

    <section class="subjects">
      <h2>Your Subjects</h2>
      <div id="subjectList" class="subject-list"></div>

      <div class="add-box">
        <input type="text" id="subjectInput" placeholder="Add new subject..." />
        <button id="addSubjectBtn">Add</button>
      </div>
    </section>
  </main>
</div>

<script>
// Toggle sidebar slide animation
function toggleSidebar() {
  const sidebar = document.getElementById("sidebar");
  const content = document.getElementById("content");
  sidebar.classList.toggle("open");
  content.classList.toggle("shift");
}

// Mark active menu entry based on current path
(function markActiveMenu() {
  try {
    const path = window.location.pathname.replace(/\/$/, '');
    const anchors = document.querySelectorAll('.menu a');
    anchors.forEach(a => {
      const href = a.getAttribute('href').replace(/\/$/, '');
      if (href === path) {
        a.parentElement.classList.add('active');
      } else {
        a.parentElement.classList.remove('active');
      }
    });
  } catch (e) { console.warn('Could not mark active menu:', e); }
})();

// Also mark nav-btn active when path matches button href
(function markActiveButtons() {
  try {
    const path = window.location.pathname.replace(/\/$/, '');
    document.querySelectorAll('.menu .nav-btn').forEach(btn => {
      const href = btn.getAttribute('onclick') ? btn.getAttribute('onclick').match(/location.href='([^']+)'/) : null;
      const url = href && href[1] ? href[1].replace(/\/$/, '') : null;
      if (url === path) btn.classList.add('active'); else btn.classList.remove('active');
    });
  } catch (e) { console.warn('Could not mark active nav buttons:', e); }
})();

// Fetch dashboard stats
function loadStats() {
  fetch('/planner/dashboard-data')
    .then(res => res.json())
    .then(data => {
      document.getElementById('ai_confidence').innerText = data.ai_confidence + '%';
      document.getElementById('learning_velocity').innerText = data.learning_velocity;
      renderSubjects(data.subjects);
    });
}

// Render subjects
function renderSubjects(subjects) {
  const box = document.getElementById('subjectList');
  box.innerHTML = '';
  subjects.forEach(sub => {
    const div = document.createElement('div');
    div.className = 'subject-item';

    // subject card content
    const title = document.createElement('div');
    title.className = 'subject-title';
    title.textContent = sub.subject || 'Unknown';

    const meta = document.createElement('div');
    meta.className = 'subject-meta';
    const badge = document.createElement('span');
    badge.className = 'subject-badge';
    badge.textContent = sub.priority || (sub.count ? `${sub.count} quizzes` : '');

    const score = document.createElement('div');
    score.className = 'subject-score';
    score.textContent = (sub.average_score !== undefined) ? `${sub.average_score}%` : (sub.score !== undefined ? `${sub.score}%` : '-');

    meta.appendChild(badge);
    meta.appendChild(score);

    const actions = document.createElement('div');
    actions.className = 'subject-actions';
    // Show delete only for user-added subjects (priority labeled 'User Added')
    if (sub.priority && sub.priority.toString().toLowerCase().includes('user')) {
      const del = document.createElement('button');
      del.className = 'delete-btn';
      del.textContent = 'Remove';
      del.addEventListener('click', () => deleteSubject(sub.subject));
      actions.appendChild(del);
    }

    div.appendChild(title);
    div.appendChild(meta);
    div.appendChild(actions);
    // make card clickable to open details modal
    div.style.cursor = 'pointer';
    div.addEventListener('click', (e) => {
      // avoid clicks on action buttons
      if (e.target.closest('.subject-actions') || e.target.classList.contains('delete-btn')) return;
      openSubjectModal(sub.subject, sub.priority);
    });
    box.appendChild(div);
  });
}

// Subject details modal controls
function openSubjectModal(subjectName, priority) {
  const backdrop = document.getElementById('subject-modal-backdrop');
  const title = document.getElementById('subject-modal-title');
  const badge = document.getElementById('subject-modal-badge');
  const recentList = document.getElementById('subject-recent-list');
  const todayMinutes = document.getElementById('subject-today-minutes');
  const avgScore = document.getElementById('subject-avg-score');

  title.textContent = subjectName;
  // color badge
  badge.className = '';
  if (!priority) priority = '';
  const p = priority.toString().toLowerCase();
  if (p.includes('high')) badge.classList.add('badge-high');
  else if (p.includes('medium')) badge.classList.add('badge-medium');
  else if (p.includes('low')) badge.classList.add('badge-low');
  else badge.classList.add('badge-user');
  badge.textContent = priority || 'User Added';

  // clear
  recentList.innerHTML = '<em>Loading…</em>';
  todayMinutes.textContent = '—';
  avgScore.textContent = '—';

  // fetch details
  fetch(`/planner/subject/${encodeURIComponent(subjectName)}/details`)
    .then(r => r.json())
    .then(data => {
      recentList.innerHTML = '';
      if (data.recent_quizzes && data.recent_quizzes.length) {
        data.recent_quizzes.forEach(q => {
          const li = document.createElement('div');
          li.style.padding = '8px 0';
          li.style.borderBottom = '1px solid rgba(255,255,255,0.03)';
          li.innerHTML = `<strong>${q.score}%</strong> <span style="color:#9fbff8; margin-left:8px;">${q.date}</span>`;
          recentList.appendChild(li);
        });
      } else {
        recentList.innerHTML = '<div>No quizzes yet for this subject.</div>';
      }

      todayMinutes.textContent = data.today_minutes + ' min';
      avgScore.textContent = data.average_score + '% (' + data.quiz_count + ')';
    })
    .catch(err => {
      recentList.innerHTML = '<div>Error loading details</div>';
      console.error(err);
    });

  backdrop.style.display = 'flex';
}

function closeSubjectModal() {
  const backdrop = document.getElementById('subject-modal-backdrop');
  backdrop.style.display = 'none';
}

// Create modal markup dynamically and append to body
(function createSubjectModal() {
  const modal = document.createElement('div');
  modal.id = 'subject-modal-backdrop';
  modal.className = 'modal-backdrop';
  modal.innerHTML = `
    <div class="modal-card">
      <div class="modal-header">
        <h3 id="subject-modal-title">Subject</h3>
        <div id="subject-modal-badge" style="margin-left:12px;"></div>
        <div style="margin-left:auto; display:flex; gap:8px;">
          <button class="close-modal" onclick="closeSubjectModal()">Close</button>
        </div>
      </div>
      <div class="modal-body">
        <div>
          <h4>Recent Quizzes</h4>
          <div id="subject-recent-list" class="modal-list"></div>
        </div>
        <div>
          <h4>Overview</h4>
          <p><strong>Today:</strong> <span id="subject-today-minutes">0 min</span></p>
          <p><strong>Average Score:</strong> <span id="subject-avg-score">-</span></p>
          <div style="margin-top:12px; display:flex; gap:8px;">
            <button class="close-modal" onclick="closeSubjectModal()">Close</button>
            <button class="delete-btn" id="subject-modal-delete">Remove</button>
          </div>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal);

  // wire delete inside modal
  document.addEventListener('click', (e) => {
    if (e.target && e.target.id === 'subject-modal-delete') {
      const name = document.getElementById('subject-modal-title').textContent;
      if (!confirm(`Remove subject "${name}"?`)) return;
      deleteSubject(name);
      closeSubjectModal();
      setTimeout(loadStats, 300);
    }
  });
})();

// Add subject
 document.getElementById('addSubjectBtn').addEventListener('click', () => {
  const sub = document.getElementById('subjectInput').value.trim();
  if (!sub) return alert('Enter subject');

  fetch('/planner/add_subject', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ subject: sub })
  })
  .then(res => res.json())
  .then(() => {
    document.getElementById('subjectInput').value = '';
    loadStats();
  });
});

// Delete subject
function deleteSubject(name) {
  fetch(`/planner/delete_subject/${name}`, { method: 'DELETE' })
    .then(() => loadStats());
}

// Initial load
loadStats();
</script>

</body>
</html>
